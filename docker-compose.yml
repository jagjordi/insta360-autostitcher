# Insta360 autostitcher stack

version: '3.8'

services:
  backend:
    build:
      context: ./backend
      args:
        - MEDIA_SDK_DEB=${MEDIA_SDK_DEB:-libMediaSDK-dev_2.0-0_amd64_ubuntu18.04.deb}
        - AI_STITCH_MODEL=${AI_STITCH_MODEL:-vendor/ai_stitch_model_v2.ins}
    container_name: insta360-backend
    env_file:
      - .env
    environment:
      APP_STORAGE_DIR: /app
      AUTO_STITCHER_LOG_LEVEL: ${AUTO_STITCHER_LOG_LEVEL:-INFO}
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility
    gpus: all
    ports:
      - "${AUTO_STITCHER_PORT:-8008}:8008"
    volumes:
      - ${APP_STORAGE_DIR}:/app
      - ${RAW_DIR}:/app/raw
      - ${OUT_DIR}:/app/stitched

  frontend:
    build:
      context: ./frontend
      args:
        - VITE_API_BASE=${VITE_API_BASE:-}
    container_name: insta360-frontend
    network_mode: host
    environment:
      NGINX_PORT: ${NGINX_PORT:-3000}
      API_PROXY_TARGET: ${BACKEND_API_URL:-http://127.0.0.1:8000}
